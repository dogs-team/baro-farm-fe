services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: barofarm-frontend
    restart: unless-stopped
    init: true

    # 서버(브리지) 모드: 호스트 백엔드에 host.docker.internal로 접근
    ports:
      - '3000:3000'
    extra_hosts:
      - 'host.docker.internal:host-gateway'

    environment:
      - NODE_ENV=production
      # 게이트웨이 주소
      - NEXT_PUBLIC_API_GATEWAY_URL=${NEXT_PUBLIC_API_GATEWAY_URL:-http://3.34.14.73:8080}
      - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-${NEXT_PUBLIC_API_GATEWAY_URL:-http://3.34.14.73:8080}}
      # 결제 클라이언트 키 (배포 환경 값으로 교체)
      - NEXT_PUBLIC_TOSS_CLIENT_KEY=${NEXT_PUBLIC_TOSS_CLIENT_KEY:-test_ck_ma60RZblrqReBBKpoZ7E8wzYWBn1}
      # 이미지 URL (Nginx가 서빙)
      - NEXT_PUBLIC_IMAGE_BASE_URL=/uploads

    # 로그 수집용 S3 마운트 (프론트는 읽기 전용 + 로그 디렉토리만 쓰기 허용)
    #   호스트에서 확인: id ubuntu (일반적으로 uid 1000)
    #   sudo mkdir -p /mnt/s3/logs/events
    volumes:
      - /mnt/s3/logs/events:/mnt/s3/logs/events:rw
    # S3 마운트에서 쓰기 권한 문제 해결: 호스트 ubuntu 사용자(uid 1000)로 실행
    # Dockerfile의 USER nextjs 설정을 오버라이드
    user: '1000:1000'  # ubuntu 사용자 (호스트에서 'id ubuntu'로 확인 가능)

    # ========================================
    # 보안 설정 (SECURITY_INCIDENT_REPORT.md 참고)
    # ========================================
    # 읽기 전용 파일 시스템 (악성 파일 쓰기 방지)
    read_only: true
    # 임시 디렉토리만 쓰기 가능 (noexec, nosuid로 실행 방지)
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
      - /var/tmp:noexec,nosuid,size=100m
    # 네트워크 격리 (필요시 추가)
    # networks:
    #   - frontend-network

    # ========================================
    # S3 마운트 정책
    # ========================================
    # - 이미지 업로드/서빙용 S3는 여전히 프론트에서 직접 접근하지 않음
    # - 예외적으로, 이벤트 로그 적재를 위해 /mnt/s3/logs/events 만 쓰기 가능
    #   (호스트의 /mnt/s3/logs/events를 컨테이너 동일 경로에 마운트)
    # ========================================
