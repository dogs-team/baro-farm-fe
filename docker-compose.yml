services:
  nginx:
    image: nginx:alpine
    container_name: barofarm-nginx
    restart: unless-stopped
    ports:
      - '80:80'
      # HTTPS 사용 시 주석 해제
      # - '443:443'
    volumes:
      # Nginx 설정 파일
      - ./nginx-docker.conf:/etc/nginx/conf.d/default.conf:ro
      # S3 마운트 경로 (호스트에서 마운트된 경로)
      - /mnt/s3/uploads:/mnt/s3/uploads:ro
      # HTTPS 인증서 (Let's Encrypt 사용 시)
      # - /etc/letsencrypt:/etc/letsencrypt:ro
    # extra_hosts 불필요: nginx-docker.conf에서 호스트 IP(3.34.14.73:8080) 직접 사용
    depends_on:
      - frontend
    networks:
      - barofarm-network
    # 리소스 제한 (메모리 최적화)
    deploy:
      resources:
        limits:
          memory: 96M # Nginx는 매우 가볍습니다 (일반적으로 10-50MB 사용)
        reservations:
          memory: 64M # 최소 메모리 보장
    # 헬스 체크 (nginx:alpine에는 wget이 없을 수 있으므로 nginx 프로세스 확인)
    healthcheck:
      test: ['CMD-SHELL', 'pgrep nginx > /dev/null || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_GATEWAY_URL=${NEXT_PUBLIC_API_GATEWAY_URL:-http://3.34.14.73:8080}
        - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-${NEXT_PUBLIC_API_GATEWAY_URL:-http://3.34.14.73:8080}}
        - NEXT_PUBLIC_TOSS_CLIENT_KEY=${NEXT_PUBLIC_TOSS_CLIENT_KEY:-test_ck_ma60RZblrqReBBKpoZ7E8wzYWBn1}
        - NEXT_PUBLIC_IMAGE_BASE_URL=/uploads
        - NEXT_PUBLIC_KAKAO_CLIENT_ID=${NEXT_PUBLIC_KAKAO_CLIENT_ID}
        - NEXT_PUBLIC_KAKAO_REDIRECT_URI=${NEXT_PUBLIC_KAKAO_REDIRECT_URI}
    container_name: barofarm-frontend
    restart: unless-stopped
    init: true

    # Nginx를 통해 접근하므로 포트 노출 불필요 (개발/디버깅 시에만 주석 해제)
    ports:
      - '3000:3000'
    # extra_hosts 불필요: Nginx를 통해 API 호출하므로 직접 백엔드 접근 없음

    environment:
      - NODE_ENV=production
      # 게이트웨이 주소
      - NEXT_PUBLIC_API_GATEWAY_URL=${NEXT_PUBLIC_API_GATEWAY_URL:-http://3.34.14.73:8080}
      - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-${NEXT_PUBLIC_API_GATEWAY_URL:-http://3.34.14.73:8080}}
      # 결제 클라이언트 키 (배포 환경 값으로 교체)
      - NEXT_PUBLIC_TOSS_CLIENT_KEY=${NEXT_PUBLIC_TOSS_CLIENT_KEY:-test_ck_ma60RZblrqReBBKpoZ7E8wzYWBn1}
      # 이미지 URL (Nginx가 서빙)
      - NEXT_PUBLIC_IMAGE_BASE_URL=/uploads

      - NEXT_PUBLIC_KAKAO_CLIENT_ID=${NEXT_PUBLIC_KAKAO_CLIENT_ID}
      - NEXT_PUBLIC_KAKAO_REDIRECT_URI=${NEXT_PUBLIC_KAKAO_REDIRECT_URI}
      - NEXT_PUBLIC_API_GATEWAY_URL=${NEXT_PUBLIC_API_GATEWAY_URL}

    # 로그 수집용 S3 마운트 (프론트는 읽기 전용 + 로그 디렉토리만 쓰기 허용)
    #   호스트에서 확인: id ubuntu (일반적으로 uid 1000)
    #   sudo mkdir -p /mnt/s3/logs/events
    volumes:
      - /mnt/s3/logs/events:/mnt/s3/logs/events:rw
    # S3 마운트에서 쓰기 권한 문제 해결: 호스트 ubuntu 사용자(uid 1000)로 실행
    # Dockerfile의 USER nextjs 설정을 오버라이드
    user: '1000:1000' # ubuntu 사용자 (호스트에서 'id ubuntu'로 확인 가능)

    # ========================================
    # 보안 설정 (SECURITY_INCIDENT_REPORT.md 참고)
    # ========================================
    # 읽기 전용 파일 시스템 (악성 파일 쓰기 방지)
    read_only: true
    # 임시 디렉토리만 쓰기 가능 (noexec, nosuid로 실행 방지)
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
      - /var/tmp:noexec,nosuid,size=100m
    # Nginx와 통신하기 위한 네트워크
    networks:
      - barofarm-network

    # ========================================
    # S3 마운트 정책
    # ========================================
    # - 이미지 업로드/서빙용 S3는 여전히 프론트에서 직접 접근하지 않음
    # - 예외적으로, 이벤트 로그 적재를 위해 /mnt/s3/logs/events 만 쓰기 가능
    #   (호스트의 /mnt/s3/logs/events를 컨테이너 동일 경로에 마운트)
    # ========================================

networks:
  barofarm-network:
    driver: bridge
