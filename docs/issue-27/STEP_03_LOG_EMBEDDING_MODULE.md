# 프론트엔드 개발 가이드 - STEP 03: 로그/임베딩 모듈 (Log/Embedding)

> 프론트엔드 개발자를 위한 로그 및 임베딩 모듈 동작 원리 설명 (참고용)

## 📋 목차

1. [모듈 개요](#모듈-개요)
2. [로그 모듈 (Log)](#로그-모듈-log)
3. [임베딩 모듈 (Embedding)](#임베딩-모듈-embedding)
4. [동작 흐름](#동작-흐름)
5. [프론트엔드 개발 시 주의사항](#프론트엔드-개발-시-주의사항)

---

## 모듈 개요

**로그 모듈 (Log)**과 **임베딩 모듈 (Embedding)**은 **내부 서비스**입니다.

⚠️ **중요**: 이 모듈들은 프론트엔드에서 **직접 호출하는 API가 없습니다**.

대신, 백엔드에서 자동으로 처리되며, 프론트엔드 개발자는 다음을 이해하면 됩니다:

1. **어떻게 동작하는지** - 개인화 추천이 작동하는 원리
2. **어떤 데이터가 필요한지** - 추천이 작동하려면 사용자 행동 로그가 필요
3. **프론트엔드에서 해야 할 일** - 사용자 ID 헤더를 올바르게 전달

---

## 로그 모듈 (Log)

### 역할

사용자의 행동 로그를 Elasticsearch에 저장합니다.

### 저장되는 로그 종류

1. **검색 로그 (SearchLog)**
   - 사용자가 검색한 키워드
   - 검색 카테고리
   - 검색 시간

2. **장바구니 로그 (CartLog)**
   - 장바구니에 추가/수정/삭제한 상품
   - 이벤트 타입 (ADDED, UPDATED, REMOVED)
   - 수량
   - 발생 시간

3. **주문 로그 (OrderLog)**
   - 주문한 상품
   - 이벤트 타입 (ORDERED)
   - 수량
   - 발생 시간

### 로그 저장 방식

- **Kafka Consumer**를 통해 자동으로 저장됩니다.
- 프론트엔드에서 직접 호출하는 API가 없습니다.
- 다른 서비스(Buyer, Order 등)에서 발생한 이벤트를 Kafka로 전송하면, AI 서비스가 이를 수신하여 로그로 저장합니다.

### 로그 저장 조건

- **검색 로그**: 통합 검색 또는 상품 검색 API 호출 시 `X-User-Id` 헤더가 있으면 자동 저장
- **장바구니 로그**: 장바구니에 상품 추가/수정/삭제 시 자동 저장
- **주문 로그**: 주문 완료 시 자동 저장

---

## 임베딩 모듈 (Embedding)

### 역할

1. **상품 임베딩**: 상품명을 벡터로 변환하여 Elasticsearch에 저장
2. **사용자 프로필 임베딩**: 사용자의 행동 로그를 기반으로 사용자 프로필 벡터 생성

### 상품 임베딩

- 상품이 생성되거나 수정될 때 자동으로 생성됩니다.
- 상품명을 OpenAI의 임베딩 모델로 벡터화하여 저장합니다.
- 유사 상품 추천에 사용됩니다.

### 사용자 프로필 임베딩

#### 생성 조건

1. **최소 로그 개수**: 최소 3개 이상의 로그가 필요합니다.
   - 검색 로그 + 장바구니 로그 + 주문 로그 합계

2. **로그 기간**: 최근 30일간의 로그만 사용합니다.

3. **로그 개수 제한**: 각 타입별로 최대 5개씩만 사용합니다.
   - 검색 로그: 최대 5개
   - 장바구니 로그: 최대 5개
   - 주문 로그: 최대 5개

#### 생성 과정

1. 사용자의 최근 30일간 로그를 조회합니다.
2. 로그에서 상품명, 검색어 등을 추출합니다.
3. 추출한 텍스트를 하나의 문자열로 합칩니다.
4. OpenAI 임베딩 모델로 벡터화합니다.
5. Elasticsearch에 저장합니다.

#### 업데이트 시점

- 사용자 행동 로그가 쌓일 때마다 자동으로 업데이트됩니다.
- Kafka Consumer에서 로그를 저장한 후, 임베딩 서비스를 호출합니다.

---

## 동작 흐름

### 개인화 추천이 작동하는 전체 흐름

```
1. 사용자가 검색/장바구니/주문 행동
   ↓
2. Buyer/Order 서비스에서 Kafka 이벤트 발행
   ↓
3. AI 서비스의 Kafka Consumer가 이벤트 수신
   ↓
4. LogWriteService가 Elasticsearch에 로그 저장
   ↓
5. UserProfileEmbeddingService가 로그를 기반으로 프로필 벡터 생성/업데이트
   ↓
6. 사용자가 개인화 추천 API 호출
   ↓
7. PersonalizedRecommendService가 프로필 벡터와 상품 벡터의 유사도 계산
   ↓
8. 추천 상품 반환
```

### 유사 상품 추천이 작동하는 흐름

```
1. 상품 생성/수정
   ↓
2. ProductEmbeddingService가 상품명을 벡터로 변환
   ↓
3. Elasticsearch에 상품 벡터 저장
   ↓
4. 사용자가 유사 상품 추천 API 호출
   ↓
5. SimilarProductRecommendService가 기준 상품 벡터와 다른 상품 벡터의 유사도 계산
   ↓
6. 유사도가 높은 상품 반환
```

---

## 프론트엔드 개발 시 주의사항

### 1. 사용자 ID 헤더 전달

개인화 추천이 작동하려면, 사용자 행동 로그가 쌓여야 합니다.

**검색 API 호출 시:**

```typescript
// ✅ 올바른 방법
const response = await apiClient.get('/search', {
  params: { q: keyword },
  headers: {
    'X-User-Id': userId, // 로그인한 사용자 ID
  },
})

// ❌ 잘못된 방법 (로그가 저장되지 않음)
const response = await apiClient.get('/search', {
  params: { q: keyword },
  // X-User-Id 헤더 없음
})
```

### 2. 개인화 추천이 비어있을 때 처리

사용자 프로필 벡터가 아직 생성되지 않았거나, 추천할 상품이 없을 수 있습니다.

```typescript
const { data: recommendations } = usePersonalizedRecommendations(userId);

if (recommendations && recommendations.length === 0) {
  // 프로필 벡터가 없거나 추천할 상품이 없음
  return <EmptyRecommendationMessage />;
}
```

**사용자에게 표시할 메시지 예시:**

- "아직 추천할 상품이 없습니다. 더 많은 상품을 둘러보시면 맞춤 추천을 받을 수 있습니다."
- "추천 상품을 보려면 더 많은 활동이 필요합니다."

### 3. 레시피 추천이 실패할 때 처리

장바구니가 비어있으면 레시피 추천이 불가능합니다.

```typescript
const { data: recipe, error } = useRecipeRecommendation(userId);

if (error?.code === 'CART_NOT_FOUND') {
  return <EmptyCartMessage />;
}
```

**사용자에게 표시할 메시지 예시:**

- "레시피 추천을 받으려면 장바구니에 상품을 담아주세요."

### 4. 로그가 쌓이기까지 시간

- 사용자가 행동을 하면 즉시 로그가 저장됩니다.
- 하지만 프로필 벡터 생성에는 **최소 3개 이상의 로그**가 필요합니다.
- 따라서 처음 가입한 사용자는 개인화 추천을 받을 수 없을 수 있습니다.

**해결 방법:**

- 개인화 추천이 비어있을 때는 인기 상품이나 카테고리별 상품을 표시
- "더 많은 활동을 하시면 맞춤 추천을 받을 수 있습니다" 안내

---

## 요약

### 프론트엔드 개발자가 해야 할 일

1. ✅ **사용자 ID 헤더 전달**
   - 검색 API 호출 시 `X-User-Id` 헤더 포함
   - 로그인한 사용자만 헤더 전달

2. ✅ **에러 처리**
   - 개인화 추천이 비어있을 때 처리
   - 레시피 추천 실패 시 처리

3. ✅ **사용자 안내**
   - 추천이 없을 때 안내 메시지 표시
   - 더 많은 활동이 필요하다는 안내

### 프론트엔드 개발자가 하지 않아도 되는 일

1. ❌ 로그 저장 API 호출 (자동 처리)
2. ❌ 임베딩 생성 API 호출 (자동 처리)
3. ❌ 프로필 벡터 업데이트 API 호출 (자동 처리)

---

## 참고 자료

- **STEP 01**: 검색 모듈 - `STEP_01_SEARCH_MODULE.md`
- **STEP 02**: 추천 모듈 - `STEP_02_RECOMMEND_MODULE.md`
- **기존 가이드**: `FRONTEND_DEVELOPMENT_GUIDE.md` (전체 API 가이드)

---

## Swagger UI

API 문서는 Swagger UI에서 확인할 수 있습니다:

- 로컬: `http://localhost:8092/swagger-ui.html`
- Docker: `http://ai-service:8092/swagger-ui.html`

**주의**: 로그/임베딩 모듈은 내부 서비스이므로 Swagger UI에 API가 표시되지 않습니다.
